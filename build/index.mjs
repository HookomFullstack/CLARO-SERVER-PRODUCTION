import{createServer as B}from"http";import z from"morgan";import N from"express";import K from"cors";import{Server as X}from"socket.io";import"dotenv/config";import{Schema as E,model as M}from"mongoose";var j=new E({username:String,instances:String,subscription:{type:String,default:()=>new Date().toLocaleString("es-CO",{timeZone:"America/Bogota"})},screen:{type:Number,default:0},limitScreen:Number}),m=M("User",j);import x from"chalk";import U from"mongoose";import F from"ora";var S=async()=>{try{let a=F(` ${x.blue("Conectando base de datos local.....")}`).start();a.spinner="arc",a.color="blue",await U.connect("mongodb+srv://MiguelFullstack:hookom119@hook.lb2oqov.mongodb.net/claro-cli"),a.color="green",a.succeed(`${x.greenBright("\xA1Base de datos local conectada con \xE9xito!")}`)}catch(a){throw console.log(a),new Error("Error a la hora de iniciar la base de datos")}};var C=({arr:a,size:t})=>{let n=[],i=a.length/t;for(let s=0;s<a.length;s+=i){let c=a.slice(s,s+i);n.push(c)}return n};var Y=a=>!isNaN(new Date(a).getTime()),V=()=>new Date(Date.now()).toISOString().split(".")[0],G=a=>{let t=V();return Date.parse(t)<=Date.parse(a)},y=a=>{let t=new Date(a);return Y(a)?G(t):"La fecha l\xEDmite no es v\xE1lida."};import P from"moment";import L from"puppeteer";import k from"axios";import H from"proxy-chain";var q=async({arrPhones:a,socket:t,username:n,sockOff:i,instanceIndex:s})=>{let c=null,o=!1,r=!1,f=!1,p=!0;for(let[l,g]of a.entries())try{if(i.connected==!1){r!=!1&&await r?.close();break}do if(p==!0){r!=!1&&await r?.close(),f=!1;do try{let{data:e}=await k(`${process.env.PROXY_API}`);c=e,f&&await new Promise(w=>setTimeout(()=>w(),3e3)),f=!0}catch(e){console.log(e)}while(c?.data===null);let b=await H.anonymizeProxy({url:`http://${c}`,port:3e3});r=await L.launch({headless:"shell",args:[`--proxy-server=${b}`,"--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--disable-gpu","--no-sandbox"]}),o=await r.newPage(),o.setDefaultNavigationTimeout(0),o.setDefaultTimeout(0),await o.setRequestInterception(!0),await o.on("request",e=>{["image","stylesheet","font"].indexOf(e.resourceType())!==-1?e.abort():e.continue()}),await o.goto("https://portalpagos.claro.com.co/phrame.php?action=despliegue_personal&clase=vistasclaro&metodo=pantalla_inicio&empresa=claro#no-back-button",{waitUntil:"domcontentloaded"}),t.to(n).emit("[claro] exectMsg",{msg:`Instancia ${s} ejecutandose....`});let u=!1;do{let e=await o.$("h1"),w=await o.evaluate(A=>A?.innerText,e);w!="Portal de PAGOS Y RECARGAS"&&(await r.close(),r=!1,o=!1,u=!0),w=="Portal de PAGOS Y RECARGAS"&&(u=!0)}while(u==!1);p=!1}while(p==!0);let O=new Date,{price:v,status:_}=await o.evaluate(async b=>{let u=new Headers,e=new FormData;e.append("FLUJOPAGOGW","PFPHM"),e.append("FLUJOPAGO","10002"),e.append("ex",""),e.append("paramLista",""),e.append("action","despliegue_personal"),e.append("campos_borrar","CLACO_NUMERO"),e.append("operacion","Adicionar"),e.append("url_modal",""),e.append("id_objeto","10002"),e.append("valor_llave",""),e.append("parametros_padre","&ValorTotal=&SaldoParcial=&NumeroCelular=&FechaVencimiento=&FORMA_PAGO=&VALOR_PLAN=&VALOR_CUOTEQUIP=&FECHA_CARGADATOS=&CODIGO_CLIENTE="),e.append("mensaje_error","Debe asignar a un responsable para la actividad a seguir"),e.append("go",""),e.append("preguardar",""),e.append("confGuardaComo","Seguro que desea duplicar este registro"),e.append("modifi_detalle",""),e.append("nombre_campo",""),e.append("latitud",""),e.append("longitud",""),e.append("enviarForm",""),e.append("autoguardar",""),e.append("guion_encuesta",""),e.append("clase","vistasclaro"),e.append("metodo","confirmacion"),e.append("empresa","claro"),e.append("NumeroCelular",`${b}`),e.append("CLACO_NUMERO",""),e.append("NRO_CUENTA",""),e.append("TIPO_TRANS",""),e.append("USRIO_NUMERO",""),e.append("IPTRANSACCION",""),e.append("TIPO_TRANS_ORIG",""),e.append("FECHA_INICIO","2024-07-13 02:21"),e.append("NumeroIdentificacion",""),e.append("CodigoCliente",""),e.append("IdentificacionDeudor",""),e.append("OrigenPago",""),e.append("mySubmit_","Continuar");let A=await fetch("https://portalpagos.claro.com.co/phrame.php?id_objeto=100002",{method:"POST",headers:u,body:e,redirect:"follow"});return{price:(await A.text()).split(`
`).filter(h=>h.includes("ValorTotalEdit")).map(h=>h.split(/[<>]/g)).flat().filter(h=>h.includes("$"))[0]?.split(",")[0].replaceAll("$","").replaceAll(".","").trim(),status:A.status}},g);if(_!=200)throw await r.close(),t.to(n).emit("[claro] exectMsg",{msg:`HA OCURRIDO UN ERROR CON LA INSTANCIA ${l} SE CERRARA AUTOMATICAMENTE`}),"error status";i.connected&&await(await o?.cookies("https://portalpagos.claro.com.co/")).map(async({name:u})=>{await o.deleteCookie({name:u})});let T=new Date().getTime()-O.getTime()+"ms";if(v){await t.to(n).emit("[claro] live",{phone:g,price:v,msg:`N\xFAmero ${g} tiene una factura con deuda de ${v} - ${T}`});continue}await t.to(n).emit("[claro] dead",{phone:g,msg:`N\xFAmero ${g} no tiene factura - ${T}`})}catch(O){console.log(O),r!=!1&&await r?.close(),t.to(n).emit("[claro] exectMsg",{msg:`Ha ocurrido un error con la instancia ${s} esta sera reiniciada....`}),a.splice(l+1,0,g),p=!0;continue}return await r.close(),t.to(n).emit("[claro] exectMsg",{msg:"Una instancia ha finalizado"})},$=async({phones:a,instances:t,socket:n,username:i,sockOff:s})=>{try{let c=await C({arr:a.flat(),size:t});return[...Array(Number(t))].map((o,r)=>o=c[r].flat()).map((o,r)=>q({arrPhones:o,socket:n,sockOff:s,username:i,instanceIndex:r}))}catch(c){console.log(c)}};var d=N();d.use(K({origin:"*"}));d.use(N.json({limit:"10000mb"}));d.use(z("common"));var D=3001,R=B(d),I=new X(R,{cors:"*",maxHttpBufferSize:1e20});await S();d.post("/user/createUser",async(a,t)=>{let{token:n,instances:i,subscription:s,screen:c,limitScreen:o,createKey:r}=a.body;if(await m.findOne({username:n}))return t.status(404).json({msg:"Este token ya existe"});if(n==null||s==null||i==null||o==null)return t.status(400).json({msg:"Por favor envie toda la informacion completa"});if(r!=process.env.CREATE_KEY)return t.status(404).json({msg:"No tienes suficientes permisos para crear usuarios"});let p=new Date(Date.now()+3600*1e3),l=P(p,"YYYY-MM-DD hh:mm:ss").add({day:s}).toISOString();return await m.create({username:n,instances:i,subscription:l,screen:c,limitScreen:o}),t.status(200).json({msg:`Token ${n} con ${o} pantallas simultanea con ${i} instancias durante ${s} dias`})});d.post("/user/getSubcription",async(a,t)=>{try{let{token:n}=a.body,i=await m.findOne({username:n});if(i==null)return t.status(404).json({msg:"Este token es invalido"});let{instances:s,subscription:c}=i;if(s==0)return t.status(404).json({msg:"No tienes instancias disponibles, por favor contacta al administrador"});let o=c;return y(o)==!1?t.status(400).json({msg:`Ya ha caducado tu subcripcion de ${o.split("T")[0].replaceAll("-"," ")} con hora ${o.split("T")[1]}, por favor contacta al administrador`}):t.status(200).json({msg:`Tienes ${s} pantallas simultaneas hasta el dia ${o.split("T")[0].replaceAll("-"," ")} con hora ${o.split("T")[1]}`})}catch(n){return console.log(n),t.status(500).json({msg:"error en el servidor"})}});d.post("/user/updateSubcription",async(a,t)=>{try{let{token:n,subscriptionDaysMore:i}=a.body,s=await m.findOne({username:n});if(s==null)return t.status(404).json({msg:"Este token es invalido"});let{subscription:c,instances:o,username:r}=s,p=y(c),l=P(new Date(Date.now()+3600*1e3),"YYYY-MM-DD hh:mm:ss").add({day:i}).toISOString();return await m.findOneAndUpdate({username:r},{$set:{subscription:l}},{new:!0}).select({userRef:0,__v:0}),t.status(200).json({msg:`Tienes ${o} pantallas simultaneas hasta el dia ${l.split("T")[0].replaceAll("-"," ")} con hora ${l.split("T")[1]}`})}catch(n){return console.log(n),t.status(500).json({msg:"error en el servidor"})}});d.get("*",async(a,t)=>t.json({ok:!0}));I.on("connection",async a=>{let t=a.handshake?.query["X-TOKEN-KEY"],n=await m.findOne({username:t});if(n==null)return a.emit("[claro] exectMsg",{msg:"\xA1Vaya! Parece tienes un usuario invalido, por favor contacta con el administrador.",error:!0}),a.disconnect(!0);let{username:i,screen:s,limitScreen:c,subscription:o,instances:r}=n;if(s>=c)return a.emit("[claro] exectMsg",{msg:"Has superado el limite de pantallas, si deseas agregar m\xE1s por favor contacta con el administrador",error:!0}),a.disconnect(!0);if(y(o)==!1)return a.emit("[claro] exectMsg",{msg:"Tu subscripcion ha expirado"});await a.join(i),a.on("[claro] initCheckerAuth",async({phones:l})=>{$({phones:l,instances:r,socket:I,sockOff:a,username:i})}),a.on("disconnect",()=>a.removeAllListeners())});R.listen(D??0,()=>console.log(`conectado al servidor ${D}`));export{I as io};
