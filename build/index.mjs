import{createServer as H}from"http";import q from"morgan";import x from"express";import B from"cors";import{Server as z}from"socket.io";import"dotenv/config";import{Schema as R,model as E}from"mongoose";var P=new R({username:String,instances:String,subscription:{type:String,default:()=>new Date().toLocaleString("es-CO",{timeZone:"America/Bogota"})},screen:{type:Number,default:0},limitScreen:Number}),f=E("User",P);import v from"chalk";import M from"mongoose";import j from"ora";var y=async()=>{try{let e=j(` ${v.blue("Conectando base de datos local.....")}`).start();e.spinner="arc",e.color="blue",await M.connect("mongodb+srv://MiguelFullstack:hookom119@hook.lb2oqov.mongodb.net/claro-cli"),e.color="green",e.succeed(`${v.greenBright("\xA1Base de datos local conectada con \xE9xito!")}`)}catch(e){throw console.log(e),new Error("Error a la hora de iniciar la base de datos")}};var T=({arr:e,size:t})=>{let n=[],i=e.length/t;for(let o=0;o<e.length;o+=i){let s=e.slice(o,o+i);n.push(s)}return n};var U=e=>!isNaN(new Date(e).getTime()),F=()=>new Date(Date.now()).toISOString().split(".")[0],k=e=>{let t=F();return Date.parse(t)<=Date.parse(e)},h=e=>{let t=new Date(e);return U(e)?k(t):"La fecha l\xEDmite no es v\xE1lida."};import _ from"moment";import V from"puppeteer";import Y from"axios";import L from"proxy-chain";var S=async({socket:e,instanceIndex:t,username:n})=>{let i=null,o=!1,s=!1,r=!1;do try{do{let{data:c}=await Y(`${process.env.PROXY_API}`);i=c,r&&await new Promise(d=>setTimeout(()=>d(),2300)),r=!0}while(i?.data===null);let l=await L.anonymizeProxy({url:`http://${i}`,port:3e3});s=await V.launch({headless:"shell",args:[`--proxy-server=${l}`,"--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--disable-gpu"]}),o=await s.newPage(),o.setDefaultNavigationTimeout(0),o.setDefaultTimeout(0),await o.setRequestInterception(!0),await o.on("request",c=>{["image","stylesheet","font"].indexOf(c.resourceType())!==-1?c.abort():c.continue()}),await o.goto("https://portalpagos.claro.com.co/phrame.php?action=despliegue_personal&clase=vistasclaro&metodo=pantalla_inicio&empresa=claro#no-back-button",{waitUntil:"domcontentloaded"}),e.to(n).emit("[claro] exectMsg",{msg:`Instancia ${t} ejecutandose....`}),await o.waitForSelector("h1",{visible:!0});let m=await o.$("h1");await o.evaluate(c=>c?.innerText,m)!="Portal de PAGOS Y RECARGAS"&&(await s.close(),s=!1,o=!1)}catch(l){console.log(l),o=!1,s=!1}while(o==!1);return{page:o,browser:s}},G=async({arrPhones:e,socket:t,username:n,sockOff:i,instanceIndex:o})=>{let s=!1,r=!1,l=await S({socket:t,instanceIndex:o,username:n});s=l.page,r=l.browser,await r.on("disconnect",await r.close());for(let[m,p]of e.entries()){if(i.connected==!1){await r.close();break}try{await s.waitForSelector("#select > div > h1");let c=new Date,{price:d,status:I}=await s.evaluate(async b=>{let w=new Headers,a=new FormData;a.append("FLUJOPAGOGW","PFPHM"),a.append("FLUJOPAGO","10002"),a.append("ex",""),a.append("paramLista",""),a.append("action","despliegue_personal"),a.append("campos_borrar","CLACO_NUMERO"),a.append("operacion","Adicionar"),a.append("url_modal",""),a.append("id_objeto","10002"),a.append("valor_llave",""),a.append("parametros_padre","&ValorTotal=&SaldoParcial=&NumeroCelular=&FechaVencimiento=&FORMA_PAGO=&VALOR_PLAN=&VALOR_CUOTEQUIP=&FECHA_CARGADATOS=&CODIGO_CLIENTE="),a.append("mensaje_error","Debe asignar a un responsable para la actividad a seguir"),a.append("go",""),a.append("preguardar",""),a.append("confGuardaComo","Seguro que desea duplicar este registro"),a.append("modifi_detalle",""),a.append("nombre_campo",""),a.append("latitud",""),a.append("longitud",""),a.append("enviarForm",""),a.append("autoguardar",""),a.append("guion_encuesta",""),a.append("clase","vistasclaro"),a.append("metodo","confirmacion"),a.append("empresa","claro"),a.append("NumeroCelular",`${b}`),a.append("CLACO_NUMERO",""),a.append("NRO_CUENTA",""),a.append("TIPO_TRANS",""),a.append("USRIO_NUMERO",""),a.append("IPTRANSACCION",""),a.append("TIPO_TRANS_ORIG",""),a.append("FECHA_INICIO","2024-07-13 02:21"),a.append("NumeroIdentificacion",""),a.append("CodigoCliente",""),a.append("IdentificacionDeudor",""),a.append("OrigenPago",""),a.append("mySubmit_","Continuar");let O=await fetch("https://portalpagos.claro.com.co/phrame.php?id_objeto=100002",{method:"POST",headers:w,body:a,redirect:"follow"});return{price:(await O.text()).split(`
`).filter(g=>g.includes("ValorTotalEdit")).map(g=>g.split(/[<>]/g)).flat().filter(g=>g.includes("$"))[0]?.split(",")[0].replaceAll("$","").replaceAll(".","").trim(),status:O.status}},p);if(I!=200)throw await r.close(),t.to(n).emit("[claro] exectMsg",{msg:`HA OCURRIDO UN ERROR CON LA INSTANCIA ${m} SE CERRARA AUTOMATICAMENTE`}),"error status";try{await(await s?.cookies("https://portalpagos.claro.com.co/")).map(async({name:w})=>{await s.deleteCookie({name:w})})}catch{await(await s?.cookies("https://portalpagos.claro.com.co/")).map(async({name:a})=>{await s.deleteCookie({name:a})})}let A=new Date().getTime()-c.getTime()+"ms";if(d){await t.to(n).emit("[claro] live",{phone:p,price:d,msg:`N\xFAmero ${p} tiene una factura con deuda de ${d} - ${A}`});continue}await t.to(n).emit("[claro] dead",{phone:p,msg:`N\xFAmero ${p} no tiene factura - ${A}`})}catch(c){console.log(c),r!=!1&&await r.close(),t.to(n).emit("[claro] exectMsg",{msg:`Ha ocurrido un error con la instancia ${o} esta sera reiniciada....`}),e.splice(m+1,0,p);let d=await S({socket:t,instanceIndex:o,username:n});s=d.page,r=d.browser;continue}}return await r.close(),t.to(n).emit("[claro] exectMsg",{msg:"Una instancia ha finalizado"}),!0},C=async({phones:e,instances:t,socket:n,username:i,sockOff:o})=>{let s=await T({arr:e.flat(),size:t});return[...Array(Number(t))].map((r,l)=>r=s[l].flat()).map((r,l)=>G({arrPhones:r,socket:n,sockOff:o,username:i,instanceIndex:l}))};var u=x();u.use(B({origin:"*"}));u.use(x.json({limit:"10000mb"}));u.use(q("common"));var D=3001,$=H(u),N=new z($,{cors:"*",maxHttpBufferSize:1e20});await y();u.post("/user/createUser",async(e,t)=>{let{token:n,instances:i,subscription:o,screen:s,limitScreen:r,createKey:l}=e.body;if(await f.findOne({username:n}))return t.status(404).json({msg:"Este token ya existe"});if(n==null||o==null||i==null||r==null)return t.status(400).json({msg:"Por favor envie toda la informacion completa"});if(l!=process.env.CREATE_KEY)return t.status(404).json({msg:"No tienes suficientes permisos para crear usuarios"});let p=new Date(Date.now()+3600*1e3),c=_(p,"YYYY-MM-DD hh:mm:ss").add({day:o}).toISOString();return await f.create({username:n,instances:i,subscription:c,screen:s,limitScreen:r}),t.status(200).json({msg:`Token ${n} con ${r} pantallas simultanea con ${i} instancias durante ${o} dias`})});u.post("/user/getSubcription",async(e,t)=>{try{let{token:n}=e.body,i=await f.findOne({username:n});if(i==null)return t.status(404).json({msg:"Este token es invalido"});let{instances:o,subscription:s}=i;if(o==0)return t.status(404).json({msg:"No tienes instancias disponibles, por favor contacta al administrador"});let r=s;return h(r)==!1?t.status(400).json({msg:`Ya ha caducado tu subcripcion de ${r.split("T")[0].replaceAll("-"," ")} con hora ${r.split("T")[1]}, por favor contacta al administrador`}):t.status(200).json({msg:`Tienes ${o} pantallas simultaneas hasta el dia ${r.split("T")[0].replaceAll("-"," ")} con hora ${r.split("T")[1]}`})}catch(n){return console.log(n),t.status(500).json({msg:"error en el servidor"})}});u.post("/user/updateSubcription",async(e,t)=>{try{let{token:n,subscriptionDaysMore:i}=e.body,o=await f.findOne({username:n});if(o==null)return t.status(404).json({msg:"Este token es invalido"});let{subscription:s,instances:r,username:l}=o,p=h(s),c=_(new Date(Date.now()+3600*1e3),"YYYY-MM-DD hh:mm:ss").add({day:i}).toISOString();return await f.findOneAndUpdate({username:l},{$set:{subscription:c}},{new:!0}).select({userRef:0,__v:0}),t.status(200).json({msg:`Tienes ${r} pantallas simultaneas hasta el dia ${c.split("T")[0].replaceAll("-"," ")} con hora ${c.split("T")[1]}`})}catch(n){return console.log(n),t.status(500).json({msg:"error en el servidor"})}});u.get("*",async(e,t)=>t.json({ok:!0}));N.on("connection",async e=>{let t=e.handshake?.query["X-TOKEN-KEY"],n=await f.findOne({username:t});if(n==null)return e.emit("[claro] exectMsg",{msg:"\xA1Vaya! Parece tienes un usuario invalido, por favor contacta con el administrador.",error:!0}),e.disconnect(!0);let{username:i,screen:o,limitScreen:s,subscription:r,instances:l}=n;if(o>=s)return e.emit("[claro] exectMsg",{msg:"Has superado el limite de pantallas, si deseas agregar m\xE1s por favor contacta con el administrador",error:!0}),e.disconnect(!0);if(h(r)==!1)return e.emit("[claro] exectMsg",{msg:"Tu subscripcion ha expirado"});await e.join(i),e.on("[claro] initCheckerAuth",async({phones:c})=>{await C({phones:c,instances:l,socket:N,sockOff:e,username:i})}),e.on("disconnect",()=>e.removeAllListeners())});$.listen(D??0,()=>console.log(`conectado al servidor ${D}`));export{N as io};
