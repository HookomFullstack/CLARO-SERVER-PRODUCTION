import{createServer as K}from"http";import X from"morgan";import D from"express";import J from"cors";import{Server as Q}from"socket.io";import"dotenv/config";import{Schema as U,model as j}from"mongoose";var F=new U({username:String,instances:String,subscription:{type:String,default:()=>new Date().toLocaleString("es-CO",{timeZone:"America/Bogota"})},screen:{type:Number,default:0},limitScreen:Number}),m=j("User",F);import C from"chalk";import Y from"mongoose";import V from"ora";var S=async()=>{try{let a=V(` ${C.blue("Conectando base de datos local.....")}`).start();a.spinner="arc",a.color="blue",await Y.connect("mongodb+srv://MiguelFullstack:hookom119@hook.lb2oqov.mongodb.net/claro-cli"),a.color="green",a.succeed(`${C.greenBright("\xA1Base de datos local conectada con \xE9xito!")}`)}catch(a){throw console.log(a),new Error("Error a la hora de iniciar la base de datos")}};var $=({arr:a,size:t})=>{let n=[],i=a.length/t;for(let s=0;s<a.length;s+=i){let c=a.slice(s,s+i);n.push(c)}return n};var L=a=>!isNaN(new Date(a).getTime()),G=()=>new Date(Date.now()).toISOString().split(".")[0],k=a=>{let t=G();return Date.parse(t)<=Date.parse(a)},b=a=>{let t=new Date(a);return L(a)?k(t):"La fecha l\xEDmite no es v\xE1lida."};import R from"moment";import H from"puppeteer";import q from"axios";import z from"proxy-chain";var B=async({arrPhones:a,socket:t,username:n,sockOff:i,instanceIndex:s})=>{let c=null,o=!1,r=!1,f=!1,p=!0,l=0;for(let[O,g]of a.entries())try{if(i.connected==!1){r!=!1&&await r?.close();break}do if(p==!0){r!=!1&&await r?.close(),f=!1;do try{let{data:e}=await q(`${process.env.PROXY_API}`);c=e,f&&await new Promise(T=>setTimeout(()=>T(),3e3)),f=!0}catch(e){console.log(e),t.to(n).emit("[claro] exectMsg",{msg:`Tienes un problema con tu proxy: ${e}`})}while(c?.data===null);let w=await z.anonymizeProxy({url:`http://${c}`,port:3e3});r=await H.launch({headless:"shell",args:[`--proxy-server=${w}`,"--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--disable-gpu","--no-sandbox","--no-zygote"]}),o=await r.newPage(),o.setDefaultNavigationTimeout(0),o.setDefaultTimeout(0),await o.setCacheEnabled(!1),await o.setRequestInterception(!0),await o.on("request",e=>{["image","stylesheet","font"].indexOf(e.resourceType())!==-1?e.abort():e.continue()}),await o.goto("https://portalpagos.claro.com.co/phrame.php?action=despliegue_personal&clase=vistasclaro&metodo=pantalla_inicio&empresa=claro#no-back-button",{waitUntil:"domcontentloaded"}),t.to(n).emit("[claro] exectMsg",{msg:`Instancia ${s} ejecutandose....`});let u=!1;do await o.evaluate(e=>e?.innerText,await o.$("h1"))!="Portal de PAGOS Y RECARGAS"&&(await r.close(),r=!1,o=!1),u=!0;while(u==!1);p=!1}while(p==!0);l==5e3&&(await o.reload({waitUntil:"domcontentloaded"}),await new Promise(w=>setTimeout(()=>w(),2e3)),l=0);let y=new Date,{price:A,status:E}=await o.evaluate(async w=>{let u=new Headers,e=new FormData;e.append("FLUJOPAGOGW","PFPHM"),e.append("FLUJOPAGO","10002"),e.append("ex",""),e.append("paramLista",""),e.append("action","despliegue_personal"),e.append("campos_borrar","CLACO_NUMERO"),e.append("operacion","Adicionar"),e.append("url_modal",""),e.append("id_objeto","10002"),e.append("valor_llave",""),e.append("parametros_padre","&ValorTotal=&SaldoParcial=&NumeroCelular=&FechaVencimiento=&FORMA_PAGO=&VALOR_PLAN=&VALOR_CUOTEQUIP=&FECHA_CARGADATOS=&CODIGO_CLIENTE="),e.append("mensaje_error","Debe asignar a un responsable para la actividad a seguir"),e.append("go",""),e.append("preguardar",""),e.append("confGuardaComo","Seguro que desea duplicar este registro"),e.append("modifi_detalle",""),e.append("nombre_campo",""),e.append("latitud",""),e.append("longitud",""),e.append("enviarForm",""),e.append("autoguardar",""),e.append("guion_encuesta",""),e.append("clase","vistasclaro"),e.append("metodo","confirmacion"),e.append("empresa","claro"),e.append("NumeroCelular",`${w}`),e.append("CLACO_NUMERO",""),e.append("NRO_CUENTA",""),e.append("TIPO_TRANS",""),e.append("USRIO_NUMERO",""),e.append("IPTRANSACCION",""),e.append("TIPO_TRANS_ORIG",""),e.append("FECHA_INICIO","2024-07-13 02:21"),e.append("NumeroIdentificacion",""),e.append("CodigoCliente",""),e.append("IdentificacionDeudor",""),e.append("OrigenPago",""),e.append("mySubmit_","Continuar");let x=await fetch("https://portalpagos.claro.com.co/phrame.php?id_objeto=100002",{method:"POST",headers:u,body:e,redirect:"follow"});return{price:await x.text().then(M=>M.split(`
`).filter(h=>h.includes("ValorTotalEdit")).map(h=>h.split(/[<>]/g)).flat().filter(h=>h.includes("$"))[0]?.split(",")[0].replaceAll("$","").replaceAll(".","").trim()),status:x.status}},g);if(E!=200)throw await r.close(),t.to(n).emit("[claro] exectMsg",{msg:`HA OCURRIDO UN ERROR CON LA INSTANCIA ${O} SE CERRARA AUTOMATICAMENTE`}),"error status";i.connected&&await(await o?.cookies("https://portalpagos.claro.com.co/")).map(async({name:u})=>{await o.deleteCookie({name:u})});let v=new Date().getTime()-y.getTime()+"ms";if(l++,A){await t.to(n).emit("[claro] live",{phone:g,price:A,msg:`N\xFAmero ${g} tiene una factura con deuda de ${A} - ${v}`});continue}await t.to(n).emit("[claro] dead",{phone:g,msg:`N\xFAmero ${g} no tiene factura - ${v}`})}catch(y){console.log(y),r!=!1&&await r?.close(),t.to(n).emit("[claro] exectMsg",{msg:`Ha ocurrido un error con la instancia ${s} esta sera reiniciada....`}),a.splice(O+1,0,g),p=!0;continue}return await r.close(),t.to(n).emit("[claro] exectMsg",{msg:"Una instancia ha finalizado"})},I=async({phones:a,instances:t,socket:n,username:i,sockOff:s})=>{try{let c=await $({arr:a.flat(),size:t});return[...Array(Number(t))].map((o,r)=>o=c[r].flat()).map((o,r)=>B({arrPhones:o,socket:n,sockOff:s,username:i,instanceIndex:r}))}catch(c){console.log(c)}};var d=D();d.use(J({origin:"*"}));d.use(D.json({limit:"10000mb"}));d.use(X("common"));var N=3001,P=K(d),_=new Q(P,{cors:"*",maxHttpBufferSize:1e20});await S();d.post("/user/createUser",async(a,t)=>{let{token:n,instances:i,subscription:s,screen:c,limitScreen:o,createKey:r}=a.body;if(await m.findOne({username:n}))return t.status(404).json({msg:"Este token ya existe"});if(n==null||s==null||i==null||o==null)return t.status(400).json({msg:"Por favor envie toda la informacion completa"});if(r!=process.env.CREATE_KEY)return t.status(404).json({msg:"No tienes suficientes permisos para crear usuarios"});let p=new Date(Date.now()+3600*1e3),l=R(p,"YYYY-MM-DD hh:mm:ss").add({day:s}).toISOString();return await m.create({username:n,instances:i,subscription:l,screen:c,limitScreen:o}),t.status(200).json({msg:`Token ${n} con ${o} pantallas simultanea con ${i} instancias durante ${s} dias`})});d.post("/user/getSubcription",async(a,t)=>{try{let{token:n}=a.body,i=await m.findOne({username:n});if(i==null)return t.status(404).json({msg:"Este token es invalido"});let{instances:s,subscription:c}=i;if(s==0)return t.status(404).json({msg:"No tienes instancias disponibles, por favor contacta al administrador"});let o=c;return b(o)==!1?t.status(400).json({msg:`Ya ha caducado tu subcripcion de ${o.split("T")[0].replaceAll("-"," ")} con hora ${o.split("T")[1]}, por favor contacta al administrador`}):t.status(200).json({msg:`Tienes ${s} pantallas simultaneas hasta el dia ${o.split("T")[0].replaceAll("-"," ")} con hora ${o.split("T")[1]}`})}catch(n){return console.log(n),t.status(500).json({msg:"error en el servidor"})}});d.post("/user/updateSubcription",async(a,t)=>{try{let{token:n,subscriptionDaysMore:i}=a.body,s=await m.findOne({username:n});if(s==null)return t.status(404).json({msg:"Este token es invalido"});let{subscription:c,instances:o,username:r}=s,p=b(c),l=R(new Date(Date.now()+3600*1e3),"YYYY-MM-DD hh:mm:ss").add({day:i}).toISOString();return await m.findOneAndUpdate({username:r},{$set:{subscription:l}},{new:!0}).select({userRef:0,__v:0}),t.status(200).json({msg:`Tienes ${o} pantallas simultaneas hasta el dia ${l.split("T")[0].replaceAll("-"," ")} con hora ${l.split("T")[1]}`})}catch(n){return console.log(n),t.status(500).json({msg:"error en el servidor"})}});d.get("*",async(a,t)=>t.json({ok:!0}));_.on("connection",async a=>{let t=a.handshake?.query["X-TOKEN-KEY"];console.log(t);let n=await m.findOne({username:t});if(n==null)return a.emit("[claro] exectMsg",{msg:"\xA1Vaya! Parece tienes un usuario invalido, por favor contacta con el administrador.",error:!0}),a.disconnect(!0);let{username:i,screen:s,limitScreen:c,subscription:o,instances:r}=n;if(s>=c)return a.emit("[claro] exectMsg",{msg:"Has superado el limite de pantallas, si deseas agregar m\xE1s por favor contacta con el administrador",error:!0}),a.disconnect(!0);if(b(o)==!1)return a.emit("[claro] exectMsg",{msg:"Tu subscripcion ha expirado"});await a.join(i),a.on("[claro] initCheckerAuth",async({phones:l})=>{I({phones:l,instances:r,socket:_,sockOff:a,username:i})}),a.on("disconnect",()=>a.removeAllListeners())});P.listen(N??0,()=>console.log(`conectado al servidor ${N}`));export{_ as io};
